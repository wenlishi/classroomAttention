<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教室布局与座位标注工具 (完整后端集成版)</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .container { width: 100%; max-width: 900px; background-color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); padding: 25px; }
        h1, h2 { text-align: center; color: #2c3e50; padding-bottom: 15px; margin-top: 0; }
        h1 { border-bottom: 2px solid #e0e0e0; }
        h2 { margin-bottom: 15px; font-size: 1.2em; color: #34495e; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .panel { margin-bottom: 25px; }
        .panel:last-child { margin-bottom: 0; }
        .controls { display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .control-group { position: relative; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
        .btn { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; transition: all 0.2s; white-space: nowrap; font-weight: 500;}
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.7; }
        .btn-primary { background-color: #3498db; color: white; } .btn-primary:hover:not(:disabled) { background-color: #2980b9; }
        .btn-success { background-color: #2ecc71; color: white; } .btn-success:hover:not(:disabled) { background-color: #27ae60; }
        .btn-warning { background-color: #f39c12; color: white; } .btn-warning:hover:not(:disabled) { background-color: #e67e22; }
        .btn-danger { background-color: #e74c3c; color: white; } .btn-danger:hover:not(:disabled) { background-color: #c0392b; }
        .input-group { display: flex; align-items: center; gap: 8px; }
        input[type="text"], input[type="password"], select { width: 100%; box-sizing: border-box; padding: 9px; font-size: 15px; border-radius: 5px; border: 1px solid #ccc; }
        #login-panel .controls { align-items: flex-end; }
        #grid-selector { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); z-index: 100; border: 1px solid #ccc; background-color: white; padding: 10px; box-shadow: 0 5px 10px rgba(0,0,0,0.15); margin-top: 5px; border-radius: 4px; }
        #selector-label { margin-bottom: 8px; text-align: center; font-size: 14px; color: #555; }
        #selector-grid { display: grid; gap: 3px; }
        .selector-cell { width: 24px; height: 24px; border: 1px solid #ddd; cursor: pointer; background-color: #f0f0f0; }
        .selector-cell.highlighted { background-color: #ff9933; border-color: #e57a00; }
        #layout-editor-container { text-align: center; }
        #layout-info { margin-bottom: 15px; font-size: 1.2em; color: #7f8c8d; height: 30px; font-weight: bold; }
        #layout-editor { display: grid; gap: 6px; margin: 0 auto; padding: 15px; border: 1px solid #e0e0e0; border-radius: 5px; background-color: #fdfdfd; max-width: fit-content; }
        .layout-cell { width: 50px; height: 50px; border: 1px solid #b0b0b0; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; user-select: none; }
        .layout-cell.desk { background-color: #FFF9C4; } .layout-cell.desk:hover { background-color: #FFF176; }
        .layout-cell.aisle { background-color: #f5f5f5; border-style: dashed; border-color: #dcdcdc; color: #ccc; font-size: 28px; } .layout-cell.aisle:hover { background-color: #e0e0e0; }
        .hidden { display: none !important; }
        #annotation-section { display: flex; gap: 20px; justify-content: center; }
        #image-container { position: relative; border: 2px dashed #ccc; background-color: #f9f9f9; text-align: center; min-height: 100px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        #image-container, #annotation-canvas { max-width: 100%; max-height: 600px; }
        #annotation-canvas { position: absolute; top: 0; left: 0; cursor: crosshair; }
        #frame-image { max-width: 100%; max-height: 100%; display: block; object-fit: contain; }
        #annotation-status { text-align: center; font-size: 1.4em; color: #e74c3c; padding: 10px; background: #fff8e1; border-radius: 5px; margin: 20px 0; min-height: 30px; }
        #custom-prompt-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        #custom-prompt-modal { background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); width: 90%; max-width: 400px; text-align: center; }
        #prompt-title { margin-top: 0; margin-bottom: 20px; color: #2c3e50; font-size: 1.1em; }
        #prompt-input { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 20px; box-sizing: border-box; }
        #prompt-buttons { display: flex; justify-content: flex-end; gap: 10px; }
    </style>
</head>
<body>
    <div id="login-panel" class="container">
        <h2>用户登录 (模拟)</h2>
        <div class="controls">
            <div class="control-group">
                <label for="username">用户名:</label>
                <input type="text" id="username" value="test@example.com">
            </div>
            <div class="control-group">
                <label for="password">密码:</label>
                <input type="password" id="password" value="string">
            </div>
            <div class="control-group">
                <button id="login-btn" class="btn btn-primary">登录并获取Token</button>
            </div>
            <div class="control-group" style="flex-grow: 1;">
                <label for="auth-token">认证Token (获取后将自动填充):</label>
                <input type="text" id="auth-token" readonly style="background-color: #eee;">
            </div>
        </div>
    </div>

    <div class="container">
        <h1>教室布局与座位标注工具</h1>
        <div class="panel">
            <h2>第一步: 定义布局和背景</h2>
            <div class="controls">
                 <div class="control-group"><button id="create-layout-btn" class="btn btn-primary">1. 创建新布局</button></div>
                 <div class="control-group">
                    <label for="frame-uploader">2. 上传课堂背景图:</label>
                    <input type="file" id="frame-uploader" accept="image/jpeg, image/png">
                </div>
                 <div class="control-group"><button id="save-layout-btn" class="btn btn-success" disabled>3. 保存完整布局到服务器</button></div>
            </div>
             <div id="layout-editor-container">
                <div id="layout-info"></div>
                <div id="layout-editor"></div>
                <div id="grid-selector" class="hidden"><div id="selector-label">选择网格尺寸</div><div id="selector-grid"></div></div>
            </div>
        </div>
        <div class="panel">
            <h2>第二步: 标注座位物理位置</h2>
            <div class="controls">
                <div class="control-group"><button id="start-annotation-btn" class="btn btn-warning" disabled>开始/重新标注</button></div>
                <div class="control-group"><button id="undo-annotation-btn" class="btn btn-danger" disabled>撤销上一步</button></div>
            </div>
            <div id="annotation-status">请先创建布局并上传一张图片</div>
            <div id="annotation-section">
                <div id="image-container"><img id="frame-image" class="hidden"><canvas id="annotation-canvas"></canvas></div>
            </div>
        </div>
        <div class="panel">
            <h2>第三步: 加载已保存的布局</h2>
             <div class="controls">
                <div class="control-group" style="flex-grow: 1;"><div class="input-group"><label for="load-layout-select">加载已有布局:</label><select id="load-layout-select"><option value="">--请先登录--</option></select></div></div>
                <div class="control-group"><button id="refresh-layouts-btn" class="btn">刷新列表</button></div>
            </div>
        </div>
    </div>

    <div id="custom-prompt-overlay" class="hidden">
        <div id="custom-prompt-modal">
            <h3 id="prompt-title"></h3>
            <input type="text" id="prompt-input" />
            <div id="prompt-buttons">
                <button id="prompt-ok-btn" class="btn btn-primary">确定</button>
                <button id="prompt-cancel-btn" class="btn">取消</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ###################################################################
    // ### API 配置与认证模块 ###
    // ###################################################################
    const API_BASE_URL = 'http://81.71.102.74:8000';
    let authToken = null;

    const loginBtn = document.getElementById('login-btn');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const authTokenInput = document.getElementById('auth-token');
    
    loginBtn.addEventListener('click', async () => {
        const username = usernameInput.value;
        const password = passwordInput.value;
        const formData = new FormData();
        formData.append('username', username);
        formData.append('password', password);

        try {
            const response = await fetch(`${API_BASE_URL}/api/v1/auth/token`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || '登录失败');
            }
            const data = await response.json();
            authToken = data.access_token;
            authTokenInput.value = authToken;
            await showCustomAlert('登录成功！现在可以加载和保存布局了。');
            await populateLoadSelect();
        } catch (error) {
            console.error('Login Error:', error);
            await showCustomAlert(`登录失败: ${error.message}`);
        }
    });

    // ###################################################################
    // ### DOM 元素引用与状态变量模块 ###
    // ###################################################################
    const createBtn = document.getElementById('create-layout-btn'), 
          saveBtn = document.getElementById('save-layout-btn'), 
          loadSelect = document.getElementById('load-layout-select'),
          refreshLayoutsBtn = document.getElementById('refresh-layouts-btn');
          
    const frameUploader = document.getElementById('frame-uploader');
    const startAnnotationBtn = document.getElementById('start-annotation-btn');
    const undoAnnotationBtn = document.getElementById('undo-annotation-btn');
    
    const selector = document.getElementById('grid-selector'), 
          selectorGrid = document.getElementById('selector-grid'),
          selectorLabel = document.getElementById('selector-label');

    const layoutInfo = document.getElementById('layout-info'), 
          editor = document.getElementById('layout-editor');

    const annotationStatus = document.getElementById('annotation-status'),
          imageContainer = document.getElementById('image-container'),
          frameImage = document.getElementById('frame-image');

    const canvas = document.getElementById('annotation-canvas'), ctx = canvas.getContext('2d');
    
    const deskIconSVG = `<svg width="42" height="42" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="12" width="42" height="26" rx="4" fill="#FBC02D" stroke="#C79100" stroke-width="2"/></svg>`;
    const aisleContent = '·';

    let currentLayoutId = null;
    let currentLayoutData = []; 
    let currentLayoutName = "";
    let annotationQueue = [], annotationData = {}, annotationHistory = [];
    let imageLoaded = false, imageFile = null;
    let scaleX = 1, scaleY = 1;
    let resizeObserver = null;

    // ###################################################################
    // ### 自定义对话框模块 (完整实现) ###
    // ###################################################################
    const promptOverlay = document.getElementById('custom-prompt-overlay');
    const promptTitle = document.getElementById('prompt-title');
    const promptInput = document.getElementById('prompt-input');
    const promptOkBtn = document.getElementById('prompt-ok-btn');
    const promptCancelBtn = document.getElementById('prompt-cancel-btn');

    function showCustomPrompt(title, defaultValue = '') {
        return new Promise((resolve) => {
            promptTitle.textContent = title;
            promptInput.value = defaultValue;
            promptInput.style.display = 'block';
            promptCancelBtn.style.display = 'inline-block';
            promptOkBtn.textContent = '确定';
            promptOverlay.classList.remove('hidden');
            promptInput.focus();
            promptInput.select();

            const closePrompt = (value) => {
                promptOverlay.classList.add('hidden');
                promptOkBtn.onclick = null;
                promptCancelBtn.onclick = null;
                document.removeEventListener('keydown', keydownHandler);
                resolve(value);
            };

            const keydownHandler = (e) => {
                if (e.key === 'Enter') {
                    if (promptInput.value.trim() !== '') { closePrompt(promptInput.value); }
                } else if (e.key === 'Escape') {
                    closePrompt(null);
                }
            };

            promptOkBtn.onclick = () => { if (promptInput.value.trim() !== '') { closePrompt(promptInput.value); } };
            promptCancelBtn.onclick = () => closePrompt(null);
            document.addEventListener('keydown', keydownHandler);
        });
    }

    function showCustomAlert(message) {
        return new Promise(resolve => {
            promptTitle.textContent = message;
            promptInput.style.display = 'none';
            promptCancelBtn.style.display = 'none';
            promptOkBtn.textContent = '好的';
            promptOverlay.classList.remove('hidden');

            const closeAlert = () => {
                promptOverlay.classList.add('hidden');
                promptOkBtn.onclick = null;
                resolve();
            };
            promptOkBtn.onclick = closeAlert;
        });
    }

    // ###################################################################
    // ### 布局创建与管理模块 (与后端交互) ###
    // ###################################################################
    
    createBtn.onclick = async () => {
        const name = await showCustomPrompt("请输入新布局的名称:", "我的新布局");
        if (name) {
            resetAllState();
            currentLayoutName = name;
            selector.classList.remove('hidden');
        }
    };
    
    function resetAllState() {
        currentLayoutId = null;
        currentLayoutName = "";
        currentLayoutData = [];
        annotationData = {};
        annotationQueue = [];
        annotationHistory = [];
        imageLoaded = false;
        imageFile = null;
        frameUploader.value = '';
        if(resizeObserver) resizeObserver.disconnect();
        frameImage.src = "";
        frameImage.classList.add('hidden');
        editor.innerHTML = '';
        ctx.clearRect(0,0, canvas.width, canvas.height);
        layoutInfo.textContent = "请创建或加载一个布局";
        annotationStatus.textContent = "请先创建布局并上传一张图片";
        updateAllButtonsState();
    }

    saveBtn.onclick = async () => {
        if (!authToken) { await showCustomAlert('请先登录！'); return; }
        if (!currentLayoutName || currentLayoutData.length === 0) { await showCustomAlert('请先创建布局网格并为其命名。'); return; }
        if (!imageFile) { await showCustomAlert('请上传一张课堂背景图。'); return; }
        if (annotationQueue.length > 0) { await showCustomAlert('请先完成所有座位的标注！'); return; }

        saveBtn.disabled = true;
        saveBtn.textContent = '保存中...';

        try {
            const formData = new FormData();
            const desks = Object.keys(annotationData).map(seatId => {
                const parts = seatId.replace('row:', '').replace('col:', '').split(',');
                const r = parseInt(parts[0]);
                const c = parseInt(parts[1]);
                const coords = annotationData[seatId];
                return { row_index: r, col_index: c, position_x: coords.x, position_y: coords.y };
            });

            if (desks.length === 0) { throw new Error("布局中没有任何座位被定义或标注。"); }

            const layoutPayload = { name: currentLayoutName, description: `一个 ${currentLayoutData.length}x${currentLayoutData[0]?.length || 0} 的布局`, desks: desks };
            formData.append('layout_data', JSON.stringify(layoutPayload));
            formData.append('file', imageFile);

            const response = await fetch(`${API_BASE_URL}/api/v1/layouts/`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${authToken}` },
                body: formData
            });

            if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || '保存失败'); }

            const newLayout = await response.json();
            await showCustomAlert(`布局 "${newLayout.name}" 已成功保存到服务器!`);
            currentLayoutId = newLayout.id;
            await populateLoadSelect(newLayout.id);

        } catch (error) {
            console.error('Save Layout Error:', error);
            await showCustomAlert(`保存失败: ${error.message}`);
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = '3. 保存完整布局到服务器';
            updateAllButtonsState();
        }
    };

    loadSelect.onchange = async () => {
        const layoutId = loadSelect.value;
        if (!layoutId) { resetAllState(); return; }
        if (!authToken) { await showCustomAlert('请先登录！'); loadSelect.value = ""; return; }

        try {
            const response = await fetch(`${API_BASE_URL}/api/v1/layouts/${layoutId}`, { headers: {'Authorization': `Bearer ${authToken}`} });
            if (!response.ok) throw new Error('加载布局详情失败');
            const layout = await response.json();

            resetAllState();
            currentLayoutId = layout.id;
            currentLayoutName = layout.name;
            
            if (layout.desks && layout.desks.length > 0) {
                 const rows = Math.max(...layout.desks.map(d => d.row_index)) + 1;
                 const cols = Math.max(...layout.desks.map(d => d.col_index)) + 1;
                 currentLayoutData = Array.from({ length: rows }, () => Array(cols).fill(0));
            }

            layout.desks.forEach(desk => {
                currentLayoutData[desk.row_index][desk.col_index] = 1;
                annotationData[`row:${desk.row_index},col:${desk.col_index}`] = { x: desk.position_x, y: desk.position_y };
            });
            renderLayoutEditor();

            frameImage.src = `${API_BASE_URL}${layout.background_image_url}`;
            frameImage.classList.remove('hidden');
            frameImage.onload = () => { 
                imageLoaded = true;
                if (!resizeObserver) { resizeObserver = new ResizeObserver(entries => { redrawAllAnnotations(); }); }
                resizeObserver.observe(frameImage);
                redrawAllAnnotations();
                updateAllButtonsState();
                annotationStatus.textContent = `布局 "${layout.name}" 加载完成。`;
            };
        } catch(error) {
            console.error('Load Layout Detail Error:', error);
            await showCustomAlert(`加载失败: ${error.message}`);
        }
    };
    
    async function populateLoadSelect(selectedValue = null) {
        if (!authToken) { loadSelect.innerHTML = '<option value="">--请先登录--</option>'; return; }
        try {
            const response = await fetch(`${API_BASE_URL}/api/v1/layouts/me`, { headers: {'Authorization': `Bearer ${authToken}`} });
            if (!response.ok) throw new Error('获取布局列表失败');
            const layouts = await response.json();
            loadSelect.innerHTML = '<option value="">--请选择一个布局加载--</option>';
            layouts.forEach(layout => {
                const option = document.createElement('option');
                option.value = layout.id;
                option.textContent = `${layout.name} (ID: ${layout.id})`;
                loadSelect.appendChild(option);
            });
            if (selectedValue) { loadSelect.value = selectedValue; }
        } catch (error) {
            console.error('Populate Layouts Error:', error);
            loadSelect.innerHTML = '<option value="">--加载列表失败--</option>';
        }
    }
    
    refreshLayoutsBtn.onclick = () => populateLoadSelect();
    
    // ###################################################################
    // ### 布局编辑器与标注模块 ###
    // ###################################################################
    
    function initializeLayoutEditor(rows, cols) { 
        currentLayoutData = Array.from({ length: rows }, () => Array(cols).fill(1)); 
        renderLayoutEditor(); 
    }

    function renderLayoutEditor() {
        editor.innerHTML = '';
        if (!currentLayoutData || currentLayoutData.length === 0) {
            layoutInfo.textContent = '请创建并选择网格尺寸';
            updateAllButtonsState();
            return;
        }
        const [rows, cols] = [currentLayoutData.length, currentLayoutData[0].length];
        layoutInfo.textContent = `当前布局: ${currentLayoutName} (${cols}列 x ${rows}排)`;
        editor.style.gridTemplateColumns = `repeat(${cols}, 50px)`;
        currentLayoutData.forEach((rowData, r) => { 
            rowData.forEach((cellData, c) => { 
                const cell = document.createElement('div'); 
                cell.classList.add('layout-cell'); 
                cell.dataset.row = r; 
                cell.dataset.col = c; 
                cell.classList.toggle('desk', cellData === 1); 
                cell.classList.toggle('aisle', cellData !== 1); 
                cell.innerHTML = cellData === 1 ? deskIconSVG : aisleContent; 
                editor.appendChild(cell); 
            }); 
        });
        updateAllButtonsState();
    }

    editor.addEventListener('click', e => { 
        const cell = e.target.closest('.layout-cell'); 
        if (!cell) return; 
        const [r, c] = [parseInt(cell.dataset.row), parseInt(cell.dataset.col)]; 
        currentLayoutData[r][c] = currentLayoutData[r][c] === 1 ? 0 : 1; 
        renderLayoutEditor(); 
    });

    frameUploader.addEventListener('change', (e) => { 
        const file = e.target.files[0]; 
        if (!file) return; 
        imageFile = file; 
        const reader = new FileReader(); 
        reader.onload = (event) => { 
            frameImage.src = event.target.result; 
            frameImage.classList.remove('hidden'); 
            frameImage.onload = () => { 
                imageLoaded = true; 
                if (!resizeObserver) { resizeObserver = new ResizeObserver(entries => { redrawAllAnnotations(); });}
                resizeObserver.observe(frameImage);
                updateAllButtonsState(); 
                redrawAllAnnotations();
            } 
        }; 
        reader.readAsDataURL(file); 
    });
    
    function updateScaleAndResizeCanvas() {
        if (!imageLoaded) return;
        const imgRect = frameImage.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        canvas.width = imgRect.width * dpr;
        canvas.height = imgRect.height * dpr;
        canvas.style.width = `${imgRect.width}px`;
        canvas.style.height = `${imgRect.height}px`;
        ctx.scale(dpr,dpr);
        scaleX = frameImage.naturalWidth / imgRect.width;
        scaleY = frameImage.naturalHeight / imgRect.height;
    }

    startAnnotationBtn.addEventListener('click', () => { 
        annotationData = {}; 
        annotationQueue = []; 
        annotationHistory = [];
        updateAllButtonsState();
        redrawAllAnnotations(); 
        if (currentLayoutData.length > 0) { 
            const deskCoords = [];
            for (let r = 0; r < currentLayoutData.length; r++) { 
                for (let c = 0; c < currentLayoutData[r].length; c++) { 
                    if (currentLayoutData[r][c] === 1) deskCoords.push({ r, c }); 
                } 
            }
            // 从左到右，从上到下的顺序
            deskCoords.sort((a,b) => a.r - b.r || a.c - b.c);
            annotationQueue = deskCoords;
        } 
        if (annotationQueue.length === 0) { 
            annotationStatus.textContent = "当前布局中没有需要标注的座位！"; 
            return; 
        } 
        promptNextAnnotation(); 
    });

    undoAnnotationBtn.addEventListener('click', () => {
        if (annotationHistory.length === 0) return;
        const lastSeatId = annotationHistory.pop();
        delete annotationData[lastSeatId];
        const parts = lastSeatId.replace('row:', '').replace('col:', '').split(',');
        annotationQueue.unshift({ r: parseInt(parts[0]), c: parseInt(parts[1]) });
        redrawAllAnnotations();
        promptNextAnnotation();
        updateAllButtonsState();
    });

    function promptNextAnnotation() { 
        if (annotationQueue.length > 0) { 
            const nextSeat = annotationQueue[0]; 
            annotationStatus.textContent = `请点击 [第 ${nextSeat.r + 1} 排, 第 ${nextSeat.c + 1} 列] 座位的位置`; 
            highlightSeatInEditor(nextSeat.r, nextSeat.c); 
        } else { 
            annotationStatus.textContent = "所有座位标注完成！现在可以保存布局了。"; 
            highlightSeatInEditor(-1, -1);
            updateAllButtonsState();
        } 
    } 

    canvas.addEventListener('click', (e) => { 
        if (annotationQueue.length === 0) return; 
        const canvasRect = canvas.getBoundingClientRect(); 
        const canvasX = e.clientX - canvasRect.left; 
        const canvasY = e.clientY - canvasRect.top; 
        const imageX = Math.round(canvasX * scaleX); 
        const imageY = Math.round(canvasY * scaleY); 
        const currentSeat = annotationQueue.shift(); 
        const seatId = `row:${currentSeat.r},col:${currentSeat.c}`; 
        annotationData[seatId] = { x: imageX, y: imageY }; 
        annotationHistory.push(seatId);
        updateAllButtonsState(); 
        redrawAllAnnotations(); 
        promptNextAnnotation(); 
    });
    
    function drawMarker(x, y) {
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, 2 * Math.PI);
        ctx.fillStyle = 'rgba(231, 76, 60, 0.95)';
        ctx.fill();
    }

    function redrawAllAnnotations() {
        if (!imageLoaded) return;
        updateScaleAndResizeCanvas();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (const seatId in annotationData) {
            const imageCoords = annotationData[seatId];
            const canvasX = imageCoords.x / scaleX;
            const canvasY = imageCoords.y / scaleY;
            drawMarker(canvasX, canvasY);
        }
    }
    
    function highlightSeatInEditor(row, col) { 
        document.querySelectorAll('.layout-cell').forEach(cell => { 
            const isTarget = cell.dataset.row == row && cell.dataset.col == col; 
            cell.style.boxShadow = isTarget ? '0 0 0 4px #e74c3c' : 'none'; 
            cell.style.transform = isTarget ? 'scale(1.1)' : 'scale(1)'; 
        }); 
    }

    function updateAllButtonsState() {
        const layoutDefined = currentLayoutData.length > 0 && currentLayoutData[0].length > 0;
        const allAnnotated = annotationQueue.length === 0 && annotationHistory.length > 0;
        const totalDesks = currentLayoutData.flat().filter(d => d===1).length;

        startAnnotationBtn.disabled = !(layoutDefined && imageLoaded);
        undoAnnotationBtn.disabled = annotationHistory.length === 0;
        saveBtn.disabled = !(layoutDefined && imageLoaded && currentLayoutName && imageFile && annotationQueue.length === 0 && annotationHistory.length === totalDesks);
    }

    // ###################################################################
    // ### 初始化模块 ###
    // ###################################################################
    
    (function initSelector(){
        selectorGrid.style.gridTemplateColumns=`repeat(12, 24px)`;
        for(let r=1;r<=12;r++){
            for(let c=1;c<=12;c++){
                const cell=document.createElement('div');
                cell.className='selector-cell';
                cell.dataset.row=r;
                cell.dataset.col=c;
                selectorGrid.appendChild(cell);
            }
        }
        selectorGrid.onmouseover=e=>{
            if(!e.target.classList.contains('selector-cell')) return;
            const [tr,tc]=[parseInt(e.target.dataset.row),parseInt(e.target.dataset.col)];
            selectorLabel.textContent=`${tc}列 x ${tr}排`;
            document.querySelectorAll('#selector-grid .selector-cell').forEach(cell=> {
                cell.classList.toggle('highlighted',cell.dataset.row<=tr&&cell.dataset.col<=tc);
            });
        };
        selectorGrid.onclick = e => {
            if (!e.target.classList.contains('selector-cell')) return;
            const [rows, cols] = [parseInt(e.target.dataset.row), parseInt(e.target.dataset.col)];
            selector.classList.add('hidden');
            initializeLayoutEditor(rows, cols);
        };
    })();

    resetAllState();
});
</script>
</body>
</html>
